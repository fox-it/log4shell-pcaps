# Flowbit/Xbit rules, lower priority to monitor for attempts
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"FOX-SRT - EXPLOIT - Possible Apache Log4j Exploit Attempt in HTTP Header"; flow:established, to_server; content:"${"; http_header; fast_pattern; content:"}"; http_header; distance:0; flowbits:set, fox.apachelog4j.rce.loose; threshold:type limit, track by_dst, count 1, seconds 3600; classtype:web-application-attack; reference:url, www.lunasec.io/docs/blog/log4j-zero-day/; reference:url, https://twitter.com/testanull/status/1469549425521348609; metadata:CVE 2021-44228; metadata:created_at 2021-12-11; priority:3; sid:21003732; rev:3;)
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"FOX-SRT - EXPLOIT - Possible Apache Log4j Exploit Attempt in URI"; flow:established, to_server; content:"${"; http_uri; fast_pattern; content:"}"; http_uri; distance:0; flowbits:set, fox.apachelog4j.rce.loose; threshold:type limit, track by_dst, count 1, seconds 3600; classtype:web-application-attack; referenceurl, www.lunasec.io/docs/blog/log4j-zero-day/; reference:url, https://twitter.com/testanull/status/1469549425521348609; metadata:CVE 2021-44228; metadata:created_at 2021-12-11; priority:3; sid:21003733; rev:3;)
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"FOX-SRT - EXPLOIT - Possible Apache Log4j Exploit Attempt in HTTP Header (strict)"; flow:established, to_server; content:"${"; http_header; fast_pattern; content:"}"; http_header; distance:0; pcre:/(\$\{\w+:.*\}|jndi)/Hi; flowbits:set, fox.apachelog4j.rce.strict; xbits:set, fox.log4shell.attempt, track ip_dst, expire 1; threshold:type limit, track by_dst, count 1, seconds 3600; classtype:web-application-attack; reference:url, www.lunasec.io/docs/blog/log4j-zero-day/; reference:url, https://twitter.com/testanull/status/1469549425521348609; metadata:CVE 2021-44228; metadata:created_at 2021-12-11; priority:3; sid:21003734; rev:4;)
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"FOX-SRT - EXPLOIT - Possible Apache Log4j Exploit Attempt in URI (strict)"; flow:established, to_server; content:"${"; http_uri; fast_pattern; content:"}"; http_uri; distance:0; pcre:/(\$\{\w+:.*\}|jndi)/Ui; flowbits:set, fox.apachelog4j.rce.strict; xbits:set, fox.log4shell.attempt, track ip_dst, expire 1; threshold:type limit, track by_dst, count 1, seconds 3600; classtype:web-application-attack; reference:url, www.lunasec.io/docs/blog/log4j-zero-day/; reference:url, https://twitter.com/testanull/status/1469549425521348609; metadata:CVE 2021-44228; metadata:created_at 2021-12-11; priority:3; sid:21003735; rev:4;)
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"FOX-SRT - EXPLOIT - Possible Apache Log4j Exploit Attempt in Basic Auth Header"; flow:established, to_server; content:"Authorization|3a 20|Basic|20|"; http_header; fast_pattern; base64_decode:bytes 200, offset 0, relative; base64_data; content:"${"; content:"}"; distance:0; xbits:set, fox.log4shell.attempt, track ip_dst, expire 1; threshold:type limit, track by_dst, count 1, seconds 3600; classtype:web-application-attack; reference:url, www.lunasec.io/docs/blog/log4j-zero-day/; reference:url, https://twitter.com/testanull/status/1469549425521348609; metadata:CVE 2021-44228; metadata:created_at 2021-12-15; priority:3; sid:21003755; rev:3;)
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"FOX-SRT - EXPLOIT - Possible Apache Log4j Exploit Attempt in Basic Auth Header (strict)"; flow:established, to_server; content:"Authorization|3a 20|Basic|20|"; http_header; fast_pattern; base64_decode:bytes 200, offset 0, relative; base64_data; content:"${"; content:"}"; distance:0; pcre:/(\$\{\w+:.*\}|jndi)/Hi; xbits:set, fox.log4shell.attempt, track ip_dst, expire 1; threshold:type limit, track by_dst, count 1, seconds 3600; classtype:web-application-attack; reference:url, www.lunasec.io/docs/blog/log4j-zero-day/; reference:url, https://twitter.com/testanull/status/1469549425521348609; metadata:CVE 2021-44228; metadata:created_at 2021-12-15; priority:3; sid:21003756; rev:3;)

# Rules to monitor follow-up traffic
alert tcp $HOME_NET any -> $EXTERNAL_NET any (msg:"FOX-SRT - Suspicious - Possible outgoing connection after Log4j Exploit Attempt"; flow:established, to_server; xbits:isset, fox.log4shell.attempt, track ip_src; stream_size:client, =, 1; stream_size:server, =, 1; threshold:type limit, track by_dst, count 1, seconds 3600; classtype:web-application-attack; reference:url, www.lunasec.io/docs/blog/log4j-zero-day/; reference:url, https://twitter.com/testanull/status/1469549425521348609; metadata:CVE 2021-44228; metadata:created_at 2021-12-12; priority:3; sid:21003740; rev:3;)
alert tcp $HOME_NET any -> $EXTERNAL_NET any (msg:"FOX-SRT - Suspicious - LDAP Bind to External Observed"; flow:established, to_server; dsize:14; content:"|02 01 03 04 00 80 00|"; offset:7; isdataat:!1, relative; threshold:type limit, track by_src, count 1, seconds 3600; classtype:bad-unknown; metadata:created_at 2021-12-11, updated_at 2021-12-17; priority:2; sid:21003738; rev:11;)
alert tcp $HOME_NET any -> $EXTERNAL_NET any (msg:"FOX-SRT - Suspicious - JRMI Request to External Observed"; flow:established, to_server; dsize:7; content:"JRMI"; depth:4; threshold:type limit, track by_src, count 1, seconds 3600; classtype:bad-unknown; reference:url,https://docs.oracle.com/javase/9/docs/specs/rmi/protocol.html; metadata:created_at 2021-12-11, updated_at 2021-12-17; priority:1; sid:21003739; rev:11;)
alert tcp $EXTERNAL_NET !445 -> $HOME_NET any (msg: "FOX-SRT - EXPLOIT - Java class inbound after CVE-2021-44228 exploit attempt (xbit)"; flow:established, to_client; content: "|CA FE BA BE 00 00 00|"; depth:40; fast_pattern; xbits:isset, fox.log4shell.attempt, track ip_dst; threshold:type limit, track by_dst, count 1, seconds 3600; classtype:successful-user; reference:url, www.lunasec.io/docs/blog/log4j-zero-day/; reference:url, https://twitter.com/testanull/status/1469549425521348609; metadata:CVE 2021-44228; metadata:created_at 2021-12-12; priority:1; sid:21003741; rev:5;)
alert tcp $EXTERNAL_NET ![445,902] -> $HOME_NET any (msg: "FOX-SRT - Suspicious - Java class inbound"; flow:established, to_client; content: "|CA FE BA BE 00 00 00|"; depth:20; fast_pattern; threshold:type limit, track by_dst, count 1, seconds 3600; classtype:bad-unknown; metadata:created_at 2021-12-12; priority:3; sid:21003742; rev:6;)
alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"FOX-SRT - Suspicious - .class Retrieval from External using Java"; flow:established, to_server; content:"GET"; http_method; content:".class"; nocase; http_uri; fast_pattern; content:"Java/"; http_user_agent; threshold:type limit, track by_src, count 1, seconds 3600; classtype:bad-unknown; metadata:created_at 2021-12-14; priority:2; sid:21003750; rev:3;)
alert tcp $EXTERNAL_NET any -> $HOME_NET any (msg:"FOX-SRT - EXPLOIT - Possible JNDI LDAP Exploitation Observed"; flow:established, from_server; content:"javaCodeBase|31|"; fast_pattern; content:"http"; distance:3; within:4; threshold:type limit, track by_dst, count 1, seconds 3600; classtype:web-application-attack; reference:url, www.lunasec.io/docs/blog/log4j-zero-day/; reference:url, https://twitter.com/testanull/status/1469549425521348609; metadata:CVE 2021-44228; metadata:created_at 2021-12-14; priority:1; sid:21003751; rev:3;):
